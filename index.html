<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The October Classic — Live Scoring</title>

  <!-- React + Babel (no build tools needed) -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Firebase (compat SDKs for simplest browser usage) -->
  <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/12.4.0/firebase-auth-compat.js"></script>

  <style>
    :root { --bg:#0f1115; --card:#151823; --muted:#9aa3b2; --text:#e8ecf1; --accent:#6ee7ff; }
    *{box-sizing:border-box} html,body,#root{height:100%}
    body{margin:0;background:linear-gradient(180deg,#0d0f14,#0b1220);color:var(--text);
      font-family:Inter,ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,"Helvetica Neue",Arial}
    .container{max-width:1100px;margin:0 auto;padding:24px}
    .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,.01));
      border:1px solid #1f2431;border-radius:18px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .hstack{display:flex;gap:12px;align-items:center}
    .vstack{display:flex;flex-direction:column;gap:12px}
    .grid{display:grid;gap:14px}
    .btn{border:1px solid #263043;background:#111827;color:var(--text);
      border-radius:12px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn:hover{border-color:#324057}
    .btn.primary{background:linear-gradient(135deg,#0ea5e9,#22d3ee);color:#071320;border:none}
    .btn.ghost{background:transparent;border:1px dashed #334155}
    .input{background:#0b1020;border:1px solid #1f2937;color:var(--text);
      border-radius:12px;padding:10px 12px;width:100%}
    .kpi{padding:10px 12px;border:1px solid #1f2431;border-radius:12px;background:#0c1221;
      display:flex;justify-content:space-between;align-items:center}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px 8px;border-bottom:1px solid #202536;text-align:left}
    .badge{padding:6px 10px;border-radius:999px;font-size:12px;border:1px solid #1f2937;background:#0f172a;}
    .small{color:var(--muted);font-size:12px}
    .sectionTitle{font-weight:800;font-size:18px}
    .title{font-size:26px;font-weight:800;margin:0}
    .copy{font-family:ui-monospace, SFMono-Regular, Menlo, monospace; font-size:12px; color:#b6c2d1}
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useEffect, useMemo, useState } = React;

    // === Firebase config (yours) ===
    const firebaseConfig = {
      apiKey: "AIzaSyCow9g5H93v4N-0NPIv5GQLGTzGx4uzu7M",
      authDomain: "october-classic.firebaseapp.com",
      projectId: "october-classic",
      storageBucket: "october-classic.firebasestorage.app",
      messagingSenderId: "784555099142",
      appId: "1:784555099142:web:6bc49c09f2ebaa3d1fef87",
      measurementId: "G-KPC9V144K5"
    };

    // Init Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // === Simple editor PIN ===
    const EDITOR_PIN = "0509"; // change anytime
    const COMP_ID = "october-classic-2025";

    // === Initial data (can edit players here if needed) ===
    const DEFAULT_PLAYERS = ["Oisin", "Neil"];
    const DEFAULT_ROUNDS = [
      { id:"d1-am",course:"Ballyliffin – Old",format:"Strokeplay",notes:"LD: 4 & 18 | CTTP: 5 & 17",front9:{},back9:{},total:{},longDrivePts:{},cttpPts:{},birdies:{},eagles:{},roundWinner:""},
      { id:"d1-pm",course:"Ballyliffin – Glashedy",format:"Strokeplay",notes:"LD: 4 & 16 | CTTP: 7 & 14",front9:{},back9:{},total:{},longDrivePts:{},cttpPts:{},birdies:{},eagles:{},roundWinner:""},
      { id:"d2-am",course:"Portsalon",format:"Matchplay",notes:"LD: 8 & 17 | CTTP: 5 & 15",front9:{},back9:{},total:{},longDrivePts:{},cttpPts:{},birdies:{},eagles:{},roundWinner:""},
      { id:"d2-pm",course:"Dunfanaghy",format:"Stableford",notes:"LD: 6 & 16 | CTTP: 9 & 13",front9:{},back9:{},total:{},longDrivePts:{},cttpPts:{},birdies:{},eagles:{},roundWinner:""},
      { id:"d3-am",course:"Cruit Island (9)",format:"Matchplay",notes:"LD: 1 & 2 | CTTP: 6 & 8",front9:{},back9:{},total:{},longDrivePts:{},cttpPts:{},birdies:{},eagles:{},roundWinner:""},
      { id:"d3-pm",course:"Narin & Portnoo",format:"Stableford",notes:"LD: 2 & 15 | CTTP: 7 & 16",front9:{},back9:{},total:{},longDrivePts:{},cttpPts:{},birdies:{},eagles:{},roundWinner:""},
      { id:"d4",course:"Day 4 – TBD",format:"Strokeplay",notes:"",front9:{},back9:{},total:{},longDrivePts:{},cttpPts:{},birdies:{},eagles:{},roundWinner:""},
      { id:"d5",course:"Mount Juliet",format:"Stableford",notes:"LD: 8 & 17 | CTTP: 3 & 11",front9:{},back9:{},total:{},longDrivePts:{},cttpPts:{},birdies:{},eagles:{},roundWinner:""}
    ];

    const POINTS = { frontBackWin: 3, roundWin: 10, birdie: 1, eagle: 5, girOverallBonus: 10 };

    // === Firestore helpers ===
    async function seedIfEmpty(players = DEFAULT_PLAYERS) {
      const ref = db.doc(`competitions/${COMP_ID}`);
      const snap = await ref.get();
      if (!snap.exists) {
        await ref.set({
          name: "The October Classic 2025",
          players,
          rounds: DEFAULT_ROUNDS,
          girOverallWinner: "",
          notes: "Enter LD/CTTP as total points for the round (include carry-overs).",
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        }, { merge: true });
      }
    }

    function useLiveCompetition() {
      const [data, setData] = useState(null);
      useEffect(() => {
        return db.doc(`competitions/${COMP_ID}`).onSnapshot((d)=> {
          setData(d.exists ? ({ id: d.id, ...d.data() }) : null);
        });
      }, []);
      return [data];
    }

    function setCompetition(update) {
      return db.doc(`competitions/${COMP_ID}`).set(update, { merge: true });
    }

    // === Scoring logic ===
    function calcNineWinnerPts(round, players) {
      const scores = {}; players.forEach(p=> scores[p]=0);
      const front = Object.entries(round.front9||{}).filter(([,v])=> typeof v === 'number');
      const back  = Object.entries(round.back9 ||{}).filter(([,v])=> typeof v === 'number');
      const award = (entries)=>{
        if (entries.length < players.length) return; // need all players for a fair compare
        const sorted = [...entries].sort((a,b)=> a[1]-b[1]); // low wins
        const low = sorted[0][1];
        const tied = sorted.filter(([,v])=> v===low).map(([k])=>k);
        if (tied.length===1) scores[tied[0]] += POINTS.frontBackWin; // simple: no split for ties
      };
      award(front); award(back);
      return scores;
    }

    function calcRoundWinnerPts(round, players) {
      const pts = {}; players.forEach(p=> pts[p]=0);
      if (round.roundWinner && players.includes(round.roundWinner)) {
        pts[round.roundWinner]+=POINTS.roundWin; 
        return pts;
      }
      // Optionally infer from totals if provided
      const totalEntries = Object.entries(round.total||{});
      if (totalEntries.length === players.length) {
        const isStroke = round.format === 'Strokeplay';
        const sorted = [...totalEntries].sort((a,b)=> isStroke? a[1]-b[1] : b[1]-a[1]);
        const top = sorted[0];
        const tie = sorted.filter(([,v])=> v===top[1]);
        if (tie.length===1) pts[top[0]] += POINTS.roundWin;
      }
      return pts;
    }

    function calcTotals(data) {
      const { players, rounds, girOverallWinner } = data;
      const tally = {}; players.forEach((p)=> tally[p] = { frontBackWins:0, roundWins:0, longDrives:0, cttps:0, birdEagle:0, girOverall:0, total:0 });

      rounds.forEach((r)=>{
        const nine = calcNineWinnerPts(r, players);
        players.forEach(p=> tally[p].frontBackWins += (nine[p]||0));

        const rw = calcRoundWinnerPts(r, players);
        players.forEach(p=> tally[p].roundWins += (rw[p]||0));

        players.forEach((p)=>{
          tally[p].longDrives += Number(r.longDrivePts?.[p]||0);
          tally[p].cttps      += Number(r.cttpPts?.[p]||0);
          const b = Number(r.birdies?.[p]||0)*POINTS.birdie;
          const e = Number(r.eagles?.[p]||0)*POINTS.eagle;
          tally[p].birdEagle += b + e;
        });
      });

      if (girOverallWinner && tally[girOverallWinner]) {
        tally[girOverallWinner].girOverall = POINTS.girOverallBonus;
      }

      players.forEach((p)=> {
        tally[p].total = tally[p].frontBackWins + tally[p].roundWins + tally[p].longDrives + tally[p].cttps + tally[p].birdEagle + tally[p].girOverall;
      });
      return tally;
    }

    // === UI components ===
    function NumberInput({ value, onChange, placeholder }) {
      return <input className="input" type="number" value={value ?? ''} placeholder={placeholder} onChange={(e)=> onChange(e.target.value===''? '': Number(e.target.value))}/>;
    }

    function RoundEditor({ r, players, onUpdate, isEditor }) {
      function patch(path, val){
        if (!isEditor) return;
        const next = { ...r };
        const segs = path.split('.');
        let cur = next;
        for (let i=0;i<segs.length-1;i++) cur = cur[segs[i]] = cur[segs[i]] ?? {};
        cur[segs[segs.length-1]] = val;
        onUpdate(next);
      }
      return (
        <div className="card vstack">
          <div className="hstack" style={{justifyContent:'space-between'}}>
            <div>
              <div className="badge">{r.format}</div>
              <div className="sectionTitle">{r.course}</div>
              <div className="small">{r.notes}</div>
            </div>
          </div>
          <div className="grid" style={{gridTemplateColumns:'1fr 1fr'}}>
            {players.map((p)=> (
              <div key={p} className="vstack">
                <div className="kpi"><b>{p}</b><span className="small">Front 9</span></div>
                <NumberInput value={r.front9?.[p]} onChange={(v)=> patch(`front9.${p}`, v)} placeholder="strokes / points" />
                <div className="kpi"><b>{p}</b><span className="small">Back 9</span></div>
                <NumberInput value={r.back9?.[p]} onChange={(v)=> patch(`back9.${p}`, v)} placeholder="strokes / points" />
                <div className="kpi"><b>{p}</b><span className="small">Total (optional)</span></div>
                <NumberInput value={r.total?.[p]} onChange={(v)=> patch(`total.${p}`, v)} placeholder="auto/enter" />
                <div className="kpi"><b>{p}</b><span className="small">Long Drive points</span></div>
                <NumberInput value={r.longDrivePts?.[p]} onChange={(v)=> patch(`longDrivePts.${p}`, v)} placeholder="inc. carryovers" />
                <div className="kpi"><b>{p}</b><span className="small">Closest-to-Pin points</span></div>
                <NumberInput value={r.cttpPts?.[p]} onChange={(v)=> patch(`cttpPts.${p}`, v)} placeholder="inc. carryovers" />
                <div className="kpi"><b>{p}</b><span className="small">Birdies</span></div>
                <NumberInput value={r.birdies?.[p]} onChange={(v)=> patch(`birdies.${p}`, v)} placeholder="count" />
                <div className="kpi"><b>{p}</b><span className="small">Eagles</span></div>
                <NumberInput value={r.eagles?.[p]} onChange={(v)=> patch(`eagles.${p}`, v)} placeholder="count" />
              </div>
            ))}
          </div>
          <div className="hstack" style={{gap:8,flexWrap:'wrap'}}>
            <span className="small">Round Winner (10 pts):</span>
            {players.map((p)=> (
              <button key={p} className={`btn ${r.roundWinner===p? 'primary':''}`} disabled={!isEditor} onClick={()=> patch('roundWinner', p)}>{p}</button>
            ))}
            {isEditor && <button className="btn ghost" onClick={()=> patch('roundWinner','')}>Clear</button>}
          </div>
        </div>
      );
    }

    function ScoreTable({ tally, players }) {
      return (
        <div className="card">
          <div className="sectionTitle">Points</div>
          <table className="table">
            <thead>
              <tr><th>Category</th>{players.map((p)=> <th key={p}>{p}</th>)}</tr>
            </thead>
            <tbody>
              <tr><td>Front 9 / Back 9 wins</td>{players.map(p=> <td key={p}>{tally[p].frontBackWins}</td>)}</tr>
              <tr><td>Round / Match wins</td>{players.map(p=> <td key={p}>{tally[p].roundWins}</td>)}</tr>
              <tr><td>Long Drives</td>{players.map(p=> <td key={p}>{tally[p].longDrives}</td>)}</tr>
              <tr><td>Closest Pins</td>{players.map(p=> <td key={p}>{tally[p].cttps}</td>)}</tr>
              <tr><td>Birdies + Eagles</td>{players.map(p=> <td key={p}>{tally[p].birdEagle}</td>)}</tr>
              <tr><td>GIR Overall</td>{players.map(p=> <td key={p}>{tally[p].girOverall}</td>)}</tr>
              <tr style={{fontWeight:800}}><td>Total</td>{players.map(p=> <td key={p}>{tally[p].total}</td>)}</tr>
            </tbody>
          </table>
          <div className="small">Scoring: Front/Back winner 3, Round winner 10, LD/CTTP = points entered, Birdie 1, Eagle 5, GIR overall +10.</div>
        </div>
      );
    }

    // === App ===
    function App(){
      const [comp] = useLiveCompetition();
      const [isEditor, setIsEditor] = useState(false);

      async function enableEdit(){
        const pin = window.prompt('Enter editor PIN');
        if (pin !== EDITOR_PIN) { alert('Incorrect PIN'); return; }
        await auth.signInAnonymously();
        await seedIfEmpty();   // ensure the document exists after sign-in
        setIsEditor(true);
      }

      function disableEdit(){ setIsEditor(false); }

      // If the competition doc doesn't exist yet, allow seeding from the landing state
      if (!comp) return (
        <div className="container vstack">
          <h1 className="title">The October Classic — Live Scoring</h1>
          <p className="small">No scores yet. A scorer must initialise the event.</p>
          <button className="btn primary" onClick={enableEdit}>I’m a scorer</button>
        </div>
      );

      const tally = useMemo(()=> calcTotals(comp), [comp]);

      return (
        <div className="container vstack" style={{gap:18}}>
          <header className="hstack" style={{justifyContent:'space-between', flexWrap:'wrap', gap:12}}>
            <div>
              <h1 className="title">{comp.name}</h1>
              <div className="small">Share this URL to view live • Click “I’m a scorer” to edit</div>
            </div>
            <div className="hstack">
              {!isEditor ? (
                <button className="btn" onClick={enableEdit}>I’m a scorer</button>
              ) : (
                <button className="btn ghost" onClick={disableEdit}>View mode</button>
              )}
            </div>
          </header>

          <section className="grid" style={{gridTemplateColumns:'repeat(auto-fit,minmax(280px,1fr))'}}>
            {comp.players.map((p)=> (
              <div key={p} className="kpi"><span>{p}</span><b className="copy">{(tally?.[p]?.total||0)} pts</b></div>
            ))}
          </section>

          <ScoreTable tally={tally} players={comp.players} />

          <section className="card vstack">
            <div className="hstack" style={{justifyContent:'space-between'}}>
              <div className="sectionTitle">GIR Overall Bonus</div>
              <div className="small">Set at the end (+10)</div>
            </div>
            <div className="hstack" style={{gap:8,flexWrap:'wrap'}}>
              {comp.players.map((p)=> (
                <button key={p} className={`btn ${comp.girOverallWinner===p? 'primary':''}`} disabled={!isEditor}
                  onClick={()=> isEditor && setCompetition({ girOverallWinner: p })}>{p}</button>
              ))}
              {isEditor && <button className="btn ghost" onClick={()=> setCompetition({ girOverallWinner: '' })}>Clear</button>}
            </div>
          </section>

          <section className="vstack">
            <div className="sectionTitle">Rounds</div>
            <div className="grid" style={{gridTemplateColumns:'1fr'}}>
              {comp.rounds.map((r, idx)=> (
                <RoundEditor key={r.id} r={r} players={comp.players} isEditor={isEditor}
                  onUpdate={(round)=>{
                    if (!isEditor) return;
                    const rounds = [...comp.rounds]; rounds[idx] = round; setCompetition({ rounds });
                  }} />
              ))}
            </div>
          </section>

          <footer className="vstack card">
            <div className="sectionTitle">Event notes</div>
            <div className="small">Enter LD/CTTP as total points for the round (include carry-overs). Front/Back winners=3, Round winner=10, Birdie=1, Eagle=5, GIR overall winner=10.</div>
          </footer>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
